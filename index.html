<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STF Clean | ãŠãã†ã˜è¦‹ç©ã‚Šï¼ˆãƒ”ã‚¯ã‚»ãƒ«ç‰ˆï¼‰</title>

  <!-- =========================
       LOOK & FEEL (fonts/colors)
       The Press Start 2P font creates the cute retro pixel vibe.
       You can remove/change this link if you prefer another style.
  ========================== -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    /* =========================
       THEME COLORS (edit safely)
       If you want different colors later, change the values below.
    ========================== */
    :root{
      --ink:#0b0f14; /* black-ish lines / text */
      --bg:#f7f7ef; /* paper background */
      --panel:#ffffff; /* white panels */
      --blue:#1d4ed8; /* primary blue */
      --blue-2:#0b3ea8; /* darker blue for borders */
      --grid:#e6e2cc; /* background pixel grid */
      --focus:#1d4ed8; /* keyboard focus outline */
      --success:#22c55e; /* green for action buttons */
      --card:#ffffff; /* option card fill */
      --card-sel:#eef3ff; /* selected card fill (soft blue) */
      --border:#c6d0f5; /* soft border for cards/inputs */
      --border-strong:#0b3ea8; /* solid border when selected */
    }

    /* =========================
       PAGE LAYOUT (safe to keep)
       You usually don't need to edit layout CSS.
    ========================== */
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      /* soft pixel grid background */
      background:
        repeating-linear-gradient(0deg, var(--grid) 0 2px, transparent 2px 24px),
        repeating-linear-gradient(90deg, var(--grid) 0 2px, transparent 2px 24px),
        var(--bg);
      color:var(--ink);
      font-family:'Press Start 2P', monospace; /* retro font */
      line-height:1.6; letter-spacing:.4px;
    }
    .wrap{ max-width:840px; margin:0 auto; padding:16px 12px 96px; }

    .title{
      display:flex; gap:8px; align-items:center; justify-content:center;
      margin:16px 0 8px; font-size:18px; text-align:center;
    }

    .tbar{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:12px; }

    .btn{
      appearance:none; border:none; background:var(--blue); color:#fff;
      padding:14px 16px; border:3px solid var(--blue-2);
      box-shadow:4px 4px 0 var(--blue-2);
      font:inherit; font-size:12px; border-radius:8px; cursor:pointer;
      transition:transform .02s ease-in;
    }
    .btn:active{ transform:translate(2px,2px); box-shadow:2px 2px 0 var(--blue-2); }
    .btn.success{ background:var(--success); border-color:#15803d; box-shadow:4px 4px 0 #15803d; }
    .btn.sm{ padding:10px 12px; font-size:11px; }

    .panel{
      background:var(--panel); border:4px solid var(--ink);
      box-shadow:6px 6px 0 var(--ink); padding:14px; margin:16px 0; border-radius:12px;
    }
    .section-title{ display:flex; align-items:center; gap:8px; margin:0 0 10px; font-size:14px; color:var(--blue-2); }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:2px solid var(--border);
      border-radius:12px; padding:12px;
      background:var(--card);
      transition:background .1s ease, border-color .1s ease, box-shadow .1s ease;
    }

    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .label{ font-size:12px; }

    .field{
      display:flex; align-items:center; gap:8px; width:100%;
      padding:10px; border:2px solid var(--border); border-radius:10px; background:#fff;
      min-height:48px;
    }
    input[type="number"], input[type="text"]{
      font:inherit; font-size:12px; padding:10px;
      border:2px solid var(--ink); border-radius:8px; width:120px;
    }
    input.wide{ width:100%; }

    /* =========================
       SELECTION CARDS (click/tap to select)
    ========================== */
    .radio-group{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    @media (max-width:480px){ .radio-group{ grid-template-columns:repeat(2,1fr); } }
    .radio{
      position:relative;
      background:#fff; border:2px solid var(--border);
      border-radius:12px; padding:14px 12px; text-align:center;
      cursor:pointer; user-select:none;
      transition:background .1s ease, border-color .1s ease, box-shadow .1s ease;
    }
    .radio small{ display:block; margin-top:4px; color:#3b4ea3; }
    .radio:hover{ border-color:#99abff; }
    .radio[aria-checked="true"]{
      background:var(--card-sel);
      border-color:var(--border-strong);
      box-shadow:0 0 0 3px rgba(13,61,168,.15) inset;
    }
    .radio[aria-checked="true"]::after{
      /* big friendly check mark in the corner */
      content:"âœ”";
      position:absolute; top:8px; right:10px;
      background:var(--blue); color:#fff;
      border:2px solid var(--blue-2);
      width:24px; height:24px; border-radius:6px;
      display:grid; place-items:center; font-size:12px;
      box-shadow:2px 2px 0 var(--blue-2);
    }

    /* =========================
       ESTIMATE LIST STYLES
    ========================== */
    .estimate{ font-size:12px; }
    .line{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid #d6defa; }
    .total{ font-size:16px; padding-top:10px; }
    .muted{ font-size:11px; opacity:.8; margin-top:6px; }

    /* =========================
       STICKY FOOTER (always-visible total)
    ========================== */
    .sticky{
      position: sticky;
      bottom: 0;
      background:#fff;
      border-top:4px solid var(--ink);
      box-shadow:0 -6px 0 var(--ink);
      padding:10px 12px;
      display:none; /* JS shows it when there are items */
      align-items:center;
      justify-content:space-between;
      gap:12px;
      z-index:15;
    }
    .sticky .sum{ font-size:14px; }

    /* =========================
       MODAL (pop-up contact form)
    ========================== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none;
      align-items:center; justify-content:center; padding:16px; z-index:20;
    }
    .modal{
      max-width:560px; width:100%; background:#fff; border:4px solid var(--ink);
      box-shadow:8px 8px 0 var(--ink); border-radius:12px; padding:16px;
    }
    .modal h3{ margin:0 0 8px; font-size:14px; color:#1d4ed8; }
    .modal .row{ margin-top:6px; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    :focus-visible{ outline:3px dashed var(--focus); outline-offset:3px; }
  </style>
</head>
<body>
  <!-- =========================
       HEADER (title + main action)
  ========================== -->
  <div class="wrap">
    <div class="title">ğŸ§¼ STF Clean Â· ãŠãã†ã˜è¦‹ç©ã‚Š</div>

    <!-- Top bar: the main contact button (opens the pop-up) -->
    <div class="tbar">
      <button class="btn success" id="contactBtn">ã“ã®å†…å®¹ã§é€£çµ¡ã™ã‚‹</button>
    </div>

    <!-- =========================
         MAIN MENU (what the customer chooses)
         Each "card" is a section. You mostly edit PRICES in JS later.
    ========================== -->
    <section class="panel" aria-labelledby="menuTitle">
      <h2 id="menuTitle" class="section-title">ğŸ§¾ ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>

      <div class="grid">
        <!-- â„ï¸ Aircon cleaning (type a number) -->
        <div class="card">
          <div class="section-title">â„ï¸ ã‚¨ã‚¢ã‚³ãƒ³æƒé™¤</div>
          <div class="field row">
            <span class="label">å°æ•°ï¼š</span>
            <!-- You can type 0, 1, 2 ... -->
            <input type="number" id="acCount" min="0" step="1" value="0" />
            <!-- This explanatory text is just info; real prices are set in JS -->
            <span class="label" style="opacity:.85;">1å°ç›® Â¥11,000ï¼åŒä¸€ç‰©ä»¶ã®è¿½åŠ  Â¥5,500</span>
          </div>
        </div>

        <!-- ğŸ§¹ Room cleaning (single-choice with ã€Œé¸æŠãªã—ã€) -->
        <div class="card">
          <div class="section-title">ğŸ§¹ éƒ¨å±‹æƒé™¤ï¼ˆé–“å–ã‚Šï¼‰</div>
          <!-- radio-group is a custom grid of tap-able choices -->
          <div id="rooms" class="radio-group" role="radiogroup" aria-label="éƒ¨å±‹ã‚¿ã‚¤ãƒ—">
            <!-- "none" = customer picks no room cleaning -->
            <div class="radio" role="radio" tabindex="0" data-key="none" aria-checked="true">é¸æŠãªã—<small>â€”</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="1R/1K" aria-checked="false">1R/1K<small>Â¥13,000</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="1DK" aria-checked="false">1DK<small>Â¥20,000</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="1LDK" aria-checked="false">1LDK<small>Â¥25,000</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="2LDK" aria-checked="false">2LDK<small>Â¥30,000</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="3LDK" aria-checked="false">3LDK<small>Â¥40,000</small></div>
          </div>
          <p class="label" style="opacity:.8;margin-top:8px;">â€» åŸºæœ¬æ¸…æƒã®ç›®å®‰ã€‚æ±šã‚Œå…·åˆã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šå¤‰å‹•ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>

        <!-- âœ¨ Options: Wax + Screen -->
        <div class="card">
          <div class="section-title">âœ¨ è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
          <div class="field row">
            <span class="label">ãƒ¯ãƒƒã‚¯ã‚¹ï¼š</span>
            <!-- wax area in square meters -->
            <input type="number" id="waxArea" min="0" step="1" value="0" />
            <span>mÂ²</span>
            <span class="label" style="opacity:.85;">Â¥220ï¼mÂ²ï¼ˆæœ€ä½ Â¥1,650ï¼‰</span>
          </div>
          <div class="field row">
            <span class="label">ğŸªŸ ç¶²æˆ¸äº¤æ›ï¼š</span>
            <!-- number of screens -->
            <input type="number" id="screenCount" min="0" step="1" value="0" />
            <span class="label" style="opacity:.85;">Â¥2,200ï¼æš</span>
          </div>
        </div>

        <!-- ğŸ  Age bracket (single-choice with ã€Œé¸æŠãªã—ã€) -->
        <div class="card">
          <div class="section-title">ğŸ  ç¯‰å¹´æ•°ï¼ˆ5å¹´åˆ»ã¿ã®å‰²å¢—ãƒ»å‰²å¼•ï¼‰</div>
          <div id="age" class="radio-group" role="radiogroup" aria-label="ç¯‰å¹´æ•°">
            <div class="radio" role="radio" tabindex="0" data-key="none" aria-checked="true">é¸æŠãªã—<small>â€”</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="<5" aria-checked="false">ã€œ5å¹´æœªæº€<small>âˆ’10%</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="5-9" aria-checked="false">5ã€œ9å¹´<small>Â±0%</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="10-14" aria-checked="false">10ã€œ14å¹´<small>+5%</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="15-19" aria-checked="false">15ã€œ19å¹´<small>+10%</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="20-24" aria-checked="false">20ã€œ24å¹´<small>+12%</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="25-29" aria-checked="false">25ã€œ29å¹´<small>+15%</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="30+" aria-checked="false">30å¹´ä»¥ä¸Š<small>+20%</small></div>
          </div>
          <p class="label" style="opacity:.8;margin-top:8px;">â€» ç¯‰å¹´æ•°ã«ã‚ˆã‚Šä½œæ¥­é›£æ˜“åº¦ãŒå¤‰ã‚ã‚‹ãŸã‚ã€åˆè¨ˆã«å‰²å¢—ãƒ»å‰²å¼•ã‚’é©ç”¨ã—ã¾ã™ã€‚</p>
        </div>

        <!-- ğŸ“ Free notes from customer -->
        <div class="card">
          <div class="section-title">ğŸ“ ã”è¦æœ›</div>
          <input class="field wide" id="note" placeholder="ä¾‹ï¼šæ°´å›ã‚Šé‡ç‚¹ãƒ»ãƒšãƒƒãƒˆã‚ã‚Šãƒ»æ—¥ç¨‹ã®å¸Œæœ› ãªã©" />
          <p class="label" style="opacity:.8;">â€» ã“ã“ã«æ›¸ã„ãŸå†…å®¹ã¯è¦‹ç©ã‚Šæœ¬æ–‡ã«ã‚‚å«ã¾ã‚Œã¾ã™ã€‚</p>
        </div>
      </div>
    </section>

    <!-- =========================
         ESTIMATE OUTPUT (what the page calculates)
         Lines appear only when something is selected/entered.
    ========================== -->
    <section class="panel" aria-labelledby="estTitle">
      <h2 id="estTitle" class="section-title">ğŸ“‹ è¦‹ç©ã‚Š</h2>
      <div id="estimate" class="estimate"></div>
      <div class="muted">
        â€» ã™ã¹ã¦ <strong>ç¨è¾¼ãƒ»é§è»Šå ´è²»è¾¼ã¿</strong> ã®ç›®å®‰é‡‘é¡ã§ã™ã€‚çŠ¶æ³ã«ã‚ˆã‚Šé‡‘é¡ãŒå¤‰å‹•ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br/>
        â€» <strong>æœ€ä½æ–™é‡‘ Â¥1,500</strong> ã‚’ä¸‹å›ã‚‹å ´åˆã¯ã€å·®é¡ã‚’åŠ ç®—ã„ãŸã—ã¾ã™ã€‚
      </div>
    </section>
  </div>

  <!-- =========================
       STICKY TOTAL BAR (shows total + contact button)
  ========================== -->
  <div class="sticky" id="sticky">
    <div class="sum">åˆè¨ˆï¼ˆ<strong>ç¨è¾¼ãƒ»é§è»Šå ´è²»è¾¼ã¿</strong>ï¼‰ï¼š<strong id="stickyTotal">Â¥0</strong></div>
    <button class="btn success sm" id="stickyContact">ã“ã®å†…å®¹ã§é€£çµ¡ã™ã‚‹</button>
  </div>

  <!-- =========================
       CONTACT MODAL (pop-up form)
       This is shown when the user clicks the contact buttons.
  ========================== -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3>ğŸ“© ã“ã®å†…å®¹ã§é€£çµ¡ã™ã‚‹</h3>

      <!-- These three inputs are OPTIONAL for the customer -->
      <div class="row">
        <input id="custName" type="text" class="wide" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰" />
      </div>
      <div class="row">
        <input id="custEmail" type="text" class="wide" placeholder="ã”é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰" />
      </div>
      <div class="row">
        <input id="custMsg" type="text" class="wide" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰" />
      </div>

      <!-- Status text (we update this in JS to show sending/ok/error) -->
      <p class="label" style="opacity:.8;">â€» é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã¯ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼ˆãƒ•ã‚©ãƒ¼ãƒ çµŒç”±ã§é€šçŸ¥ï¼‰ã€‚</p>
      <div id="sendStatus" class="label" style="opacity:.9;"></div>

      <!-- Action buttons -->
      <div class="actions">
        <button class="btn" id="cancelSend">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn success" id="sendBtn">é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    /* ===============================================================
       ğŸ”§ SETTINGS YOU CAN EDIT (prices, min charge, and endpoint)
       Search for these later if you want to change numbers.
    =============================================================== */

    // âœ… Your Formspree endpoint (already provided by you)
    // If you ever need to swap services, just change this URL.
    const WEBHOOK_URL = "https://formspree.io/f/xandlaqr";

    // â–¶ Room base prices (TAX INCLUDED). Edit numbers only.
    const ROOM_PRICES = {
      "1R/1K": 13000,
      "1DK": 20000,
      "1LDK": 25000,
      "2LDK": 30000,
      "3LDK": 40000
    };

    // â–¶ Aircon (TAX INCLUDED): first unit, then additional units
    const AC_FIRST = 11000;
    const AC_ADD = 5500;

    // â–¶ Wax (TAX INCLUDED): per mÂ² and minimum
    const WAX_PER_M2 = 220;
    const WAX_MIN = 1650;

    // â–¶ Screen replacement (TAX INCLUDED): per piece
    const SCREEN_PER = 2200;

    // â–¶ Age brackets (percent, e.g., 0.10 = +10%, -0.10 = -10%)
    // If you prefer fixed yen instead of %, tell me and I can convert.
    const AGE_BRACKETS = {
      "<5": -0.10,
      "5-9": 0.00,
      "10-14": 0.05,
      "15-19": 0.10,
      "20-24": 0.12,
      "25-29": 0.15,
      "30+": 0.20
    };

    // â–¶ Overall minimum charge (TAX INCLUDED)
    const OVERALL_MIN_TOTAL = 1500;

    /* ===============================================================
       ğŸ”— DOM ELEMENTS (we â€œhookâ€ the HTML elements by their IDs)
       You donâ€™t need to edit these; they let JS update the page.
    =============================================================== */
    const acCountEl = document.getElementById('acCount');
    const waxAreaEl = document.getElementById('waxArea');
    const screenCountEl = document.getElementById('screenCount');
    const noteEl = document.getElementById('note');
    const estimateEl = document.getElementById('estimate');

    const roomsEl = document.getElementById('rooms');
    const ageEl = document.getElementById('age');

    const contactBtn = document.getElementById('contactBtn');
    const sticky = document.getElementById('sticky');
    const stickyTotal = document.getElementById('stickyTotal');
    const stickyContact = document.getElementById('stickyContact');

    const modal = document.getElementById('modal');
    const cancelSend = document.getElementById('cancelSend');
    const sendBtn = document.getElementById('sendBtn');
    const sendStatus = document.getElementById('sendStatus');
    const custName = document.getElementById('custName');
    const custEmail = document.getElementById('custEmail');
    const custMsg = document.getElementById('custMsg');

    /* ===============================================================
       ğŸ§  STATE (whatâ€™s currently selected)
       Start with â€œnoneâ€ for room and age. Numbers start at 0.
    =============================================================== */
    let selectedRoom = null; // or "1DK", "2LDK", etc. when chosen
    let selectedAge = null; // or "<5", "10-14", etc. when chosen

    /* ===============================================================
       ğŸ›ï¸ INTERACTIONS for Room & Age cards
       - Click a card to select it.
       - Click the same card again OR click ã€Œé¸æŠãªã—ã€ to clear.
    =============================================================== */
    // Room selection
    roomsEl.querySelectorAll('.radio').forEach(r => {
      r.addEventListener('click', () => chooseRoom(r.dataset.key));
      r.addEventListener('keydown', (e) => { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); chooseRoom(r.dataset.key); } });
    });
    function chooseRoom(key){
      if(key === 'none'){ selectedRoom = null; }
      else if(selectedRoom === key){ selectedRoom = null; } // toggle off
      else { selectedRoom = key; }

      roomsEl.querySelectorAll('.radio').forEach(x => {
        const isChecked = (selectedRoom === null && x.dataset.key === 'none') || (x.dataset.key === selectedRoom);
        x.setAttribute('aria-checked', isChecked ? 'true' : 'false');
      });
      render();
    }

    // Age selection
    ageEl.querySelectorAll('.radio').forEach(r => {
      r.addEventListener('click', () => chooseAge(r.dataset.key));
      r.addEventListener('keydown', (e) => { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); chooseAge(r.dataset.key); } });
    });
    function chooseAge(key){
      if(key === 'none'){ selectedAge = null; }
      else if(selectedAge === key){ selectedAge = null; }
      else { selectedAge = key; }

      ageEl.querySelectorAll('.radio').forEach(x => {
        const isChecked = (selectedAge === null && x.dataset.key === 'none') || (x.dataset.key === selectedAge);
        x.setAttribute('aria-checked', isChecked ? 'true' : 'false');
      });
      render();
    }

    /* ===============================================================
       ğŸ§® PRICE CALCULATION (the â€œmathâ€)
       This function reads inputs, computes line items, and totals.
       If you change prices above, the math updates automatically.
    =============================================================== */
    function compute(){
      // Read numeric inputs (prevent negatives)
      const acCount = Math.max(0, parseInt(acCountEl.value || "0", 10));
      const waxArea = Math.max(0, parseInt(waxAreaEl.value || "0", 10));
      const screenCount = Math.max(0, parseInt(screenCountEl.value || "0", 10));
      const note = (noteEl.value || "").trim();

      // Aircon: first unit full price, additional units at reduced price
      let ac = 0;
      if(acCount > 0){
        ac = AC_FIRST + Math.max(0, acCount - 1) * AC_ADD;
      }

      // Room base (0 if none selected)
      const room = selectedRoom ? (ROOM_PRICES[selectedRoom] || 0) : 0;

      // Wax: mÂ² Ã— rate, but never below the minimum
      let wax = 0;
      if(waxArea > 0){
        wax = Math.max(WAX_MIN, waxArea * WAX_PER_M2);
      }

      // Screen: count Ã— unit price
      const screen = screenCount * SCREEN_PER;

      // Build the items that will show up in the estimate list
      const items = [];
      if(acCount>0) items.push({label:`â„ï¸ ã‚¨ã‚¢ã‚³ãƒ³æƒé™¤ï¼ˆ${acCount}å°ï¼‰`, price: ac});
      if(selectedRoom) items.push({label:`ğŸ§¹ éƒ¨å±‹æƒé™¤ï¼ˆ${selectedRoom}ï¼‰`, price: room});
      if(waxArea>0) items.push({label:`âœ¨ ãƒ¯ãƒƒã‚¯ã‚¹ï¼ˆ${waxArea}mÂ²ï¼‰`, price: wax});
      if(screenCount>0) items.push({label:`ğŸªŸ ç¶²æˆ¸äº¤æ›ï¼ˆ${screenCount}æšï¼‰`, price: screen});

      // Subtotal = sum of selected items
      const subtotal = items.reduce((s, x)=>s+x.price, 0);

      // Age adjustment = % of subtotal (only if an age bracket is chosen)
      const pct = selectedAge ? (AGE_BRACKETS[selectedAge] ?? 0) : 0;
      const ageAdj = Math.round(subtotal * pct);

      // Total before minimum charge
      const preMinTotal = subtotal + ageAdj;

      // Minimum charge logic: if total is positive but below minimum, add difference
      const needsMin = items.length > 0 && preMinTotal > 0 && preMinTotal < OVERALL_MIN_TOTAL;
      const minAdj = needsMin ? (OVERALL_MIN_TOTAL - preMinTotal) : 0;

      // Final total (ç¨è¾¼ã¿ãƒ»é§è»Šå ´è²»è¾¼ã¿)
      const total = preMinTotal + minAdj;

      // Return everything we need to render + send
      return { items, subtotal, agePct:pct, ageAdj, minAdj, total, note, hasAge: !!selectedAge };
    }

    /* ===============================================================
       ğŸ–¼ï¸ RENDER (draw the estimate list + sticky footer)
       This updates the visible list and the bottom bar total.
    =============================================================== */
    function render(){
      const { items, subtotal, agePct, ageAdj, minAdj, total, hasAge } = compute();
      estimateEl.innerHTML = '';

      if(items.length === 0){
        // Nothing chosen yet â†’ show a hint
        estimateEl.innerHTML = '<p class="label" style="opacity:.8;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é …ç›®ã‚’å…¥åŠ›ï¼é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
      } else {
        // Show each line item the customer picked
        items.forEach(it => {
          const row = document.createElement('div');
          row.className = 'line';
          row.innerHTML = `<div>${it.label}</div><div>Â¥${it.price.toLocaleString()}</div>`;
          estimateEl.appendChild(row);
        });

        // Subtotal
        const subRow = document.createElement('div');
        subRow.className = 'line';
        subRow.innerHTML = `<div>å°è¨ˆ</div><div>Â¥${subtotal.toLocaleString()}</div>`;
        estimateEl.appendChild(subRow);

        // Age adjustment (only if chosen)
        if(hasAge){
          const sign = ageAdj >= 0 ? '+' : 'âˆ’';
          const pctText = (agePct * 100) >= 0 ? `+${(agePct*100).toFixed(0)}%` : `${(agePct*100).toFixed(0)}%`;
          const adjRow = document.createElement('div');
          adjRow.className = 'line';
          adjRow.innerHTML = `<div>ğŸ  ç¯‰å¹´æ•°èª¿æ•´ï¼ˆ${pctText}ï¼‰</div><div>${sign}Â¥${Math.abs(ageAdj).toLocaleString()}</div>`;
          estimateEl.appendChild(adjRow);
        }

        // Minimum charge (only if applied)
        if(minAdj > 0){
          const minRow = document.createElement('div');
          minRow.className = 'line';
          minRow.innerHTML = `<div>ğŸ”– æœ€ä½æ–™é‡‘èª¿æ•´ï¼ˆæœ€ä½ Â¥${OVERALL_MIN_TOTAL.toLocaleString()}ï¼‰</div><div>+Â¥${minAdj.toLocaleString()}</div>`;
          estimateEl.appendChild(minRow);
        }

        // Final total (clear & customer-friendly)
        const totalRow = document.createElement('div');
        totalRow.className = 'line total';
        totalRow.innerHTML = `<strong>åˆè¨ˆï¼ˆ<span style="font-weight:700">ç¨è¾¼ãƒ»é§è»Šå ´è²»è¾¼ã¿</span>ï¼‰</strong><strong>Â¥${total.toLocaleString()}</strong>`;
        estimateEl.appendChild(totalRow);
      }

      // Update the sticky footer (shows at bottom when there are items)
      const computed = compute();
      stickyTotal.textContent = `Â¥${computed.total.toLocaleString()}`;
      sticky.style.display = computed.items.length ? 'flex' : 'none';
    }

    /* ===============================================================
       ğŸ”’ MODAL OPEN/CLOSE (pop-up behavior)
       - openModal(): shows the pop-up
       - closeModal(): hides it + clears any status text
       - Also supports: click outside box, press Esc, and a Cancel button.
    =============================================================== */
    function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); sendStatus.textContent=''; }

    // Close when clicking the dark backdrop (outside the white box)
    modal.addEventListener('click', (e) => { if(e.target === modal){ closeModal(); } });

    // Close with the Escape key
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false'){ closeModal(); }
    });

    // Top â€œcontactâ€ button
    contactBtn.addEventListener('click', () => {
      if(compute().items.length === 0){
        alert('ã¾ãšã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å…¥åŠ›ï¼é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      openModal();
    });

    // Sticky footer â€œcontactâ€ button
    stickyContact.addEventListener('click', () => {
      if(compute().items.length === 0){ return; }
      openModal();
    });

    // Cancel button closes the pop-up
    cancelSend.addEventListener('click', closeModal);

    /* ===============================================================
       âœ‰ï¸ BUILD THE MESSAGE TEXT (what you receive via email)
       This is a human-friendly summary we include in the payload.
    =============================================================== */
    function buildText(){
      const { items, subtotal, agePct, ageAdj, minAdj, total, note, hasAge } = compute();
      const lines = [];
      lines.push('ã€STF Clean ãŠãã†ã˜è¦‹ç©ã‚Šã€‘');
      items.forEach(it => lines.push(`ãƒ»${it.label}ï¼šÂ¥${it.price.toLocaleString()}`));
      lines.push(`å°è¨ˆï¼šÂ¥${subtotal.toLocaleString()}`);
      if(hasAge){
        const pctText = (agePct*100) >= 0 ? `+${(agePct*100).toFixed(0)}%` : `${(agePct*100).toFixed(0)}%`;
        lines.push(`ç¯‰å¹´æ•°èª¿æ•´ï¼ˆ${pctText}ï¼‰ï¼š${ageAdj >= 0 ? '+' : 'âˆ’'}Â¥${Math.abs(ageAdj).toLocaleString()}`);
      }
      if(minAdj > 0){
        lines.push(`æœ€ä½æ–™é‡‘èª¿æ•´ï¼ˆæœ€ä½ Â¥${OVERALL_MIN_TOTAL.toLocaleString()}ï¼‰ï¼š+Â¥${minAdj.toLocaleString()}`);
      }
      lines.push(`â€”â€”â€”`);
      lines.push(`åˆè¨ˆï¼ˆç¨è¾¼ãƒ»é§è»Šå ´è²»è¾¼ã¿ï¼‰ï¼šÂ¥${total.toLocaleString()}`);
      if(note){ lines.push(`ã”è¦æœ›ï¼š${note}`); }
      const now = new Date();
      lines.push(`ä½œæˆï¼š${now.toLocaleString('ja-JP')}`);
      return lines.join('\n');
    }

    /* ===============================================================
       ğŸ“¨ SEND to FORMSPREE (this is the ONLY part that changed
       from the earlier GAS version). It posts JSON to your endpoint.
    =============================================================== */
    sendBtn.addEventListener('click', async () => {
      // Build the payload (what we send to Formspree)
      const payload = {
        estimate_text: buildText(),
        selections: compute(), // includes totals + details
        customer: {
          name: (custName.value || '').trim(),
          email: (custEmail.value || '').trim(),
          message:(custMsg.value || '').trim()
        },
        // These special keys help Formspree set subject + reply-to
        _subject: "STF Clean æ–°è¦è¦‹ç©ã‚Šï¼ˆã‚µã‚¤ãƒˆã‹ã‚‰ï¼‰",
        _replyto: (custEmail.value || '').trim()
      };

      // UI: show â€œsendingâ€¦â€
      sendStatus.textContent = 'é€ä¿¡ä¸­â€¦';

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json' // recommended by Formspree
          },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          sendStatus.textContent = 'âœ… é€ä¿¡ã—ã¾ã—ãŸã€‚æ‹…å½“è€…ã‹ã‚‰ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚';
          setTimeout(() => { closeModal(); }, 1500); // auto-close after a short pause
        } else {
          // If something goes wrong (e.g., wrong endpoint), show status code
          sendStatus.textContent = 'âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ' + res.status + 'ï¼‰ã€‚';
        }
      } catch (err) {
        // Network / CORS issues â†’ show a friendly error
        sendStatus.textContent = 'âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      }
    });

    /* ===============================================================
       ğŸ” LIVE UPDATES (recalculate when inputs change)
       This keeps the estimate fresh as the user types/selects.
    =============================================================== */
    [acCountEl, waxAreaEl, screenCountEl, noteEl].forEach(el => {
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    });

    // Kick off the initial draw
    render();
  </script>
</body>
</html>
