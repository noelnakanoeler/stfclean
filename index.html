<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STFクリーン | おそうじ見積り（ピクセル版）</title>

  <!-- Retro pixel font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0b0f14; --bg:#f7f7ef; --panel:#ffffff;
      --blue:#1d4ed8; --blue-2:#0b3ea8; --grid:#e6e2cc; --focus:#1d4ed8;
      --success:#22c55e; --card:#ffffff; --card-sel:#eef3ff;
      --border:#c6d0f5; --border-strong:#0b3ea8;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        repeating-linear-gradient(0deg, var(--grid) 0 2px, transparent 2px 24px),
        repeating-linear-gradient(90deg, var(--grid) 0 2px, transparent 2px 24px),
        var(--bg);
      color:var(--ink);
      font-family:'Press Start 2P', monospace;
      line-height:1.6; letter-spacing:.4px;
    }
    .wrap{ max-width:840px; margin:0 auto; padding:16px 12px 96px; }

    .title{
      display:flex; gap:8px; align-items:center; justify-content:center;
      margin:16px 0 8px; font-size:18px; text-align:center;
    }

    .tbar{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:12px; }

    .btn{
      appearance:none; border:none; background:var(--blue); color:#fff;
      padding:14px 16px; border:3px solid var(--blue-2);
      box-shadow:4px 4px 0 var(--blue-2);
      font:inherit; font-size:12px; border-radius:8px; cursor:pointer;
      transition:transform .02s ease-in;
    }
    .btn:active{ transform:translate(2px,2px); box-shadow:2px 2px 0 var(--blue-2); }
    .btn.success{ background:var(--success); border-color:#15803d; box-shadow:4px 4px 0 #15803d; }
    .btn.sm{ padding:10px 12px; font-size:11px; }

    .panel{
      background:var(--panel); border:4px solid var(--ink);
      box-shadow:6px 6px 0 var(--ink); padding:14px; margin:16px 0; border-radius:12px;
    }
    .section-title{ display:flex; align-items:center; gap:8px; margin:0 0 10px; font-size:14px; color:var(--blue-2); }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:2px solid var(--border);
      border-radius:12px; padding:12px;
      background:var(--card);
      transition:background .1s ease, border-color .1s ease, box-shadow .1s ease;
    }

    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .label{ font-size:12px; }

    .field{
      display:flex; align-items:center; gap:8px; width:100%;
      padding:10px; border:2px solid var(--border); border-radius:10px; background:#fff;
      min-height:48px;
    }
    input[type="number"], input[type="text"]{
      font:inherit; font-size:12px; padding:10px;
      border:2px solid var(--ink); border-radius:8px; width:120px;
    }
    input.wide{ width:100%; }

    /* Selection cards */
    .radio-group{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    @media (max-width:480px){ .radio-group{ grid-template-columns:repeat(2,1fr); } }
    .radio{
      position:relative;
      background:#fff; border:2px solid var(--border);
      border-radius:12px; padding:14px 12px; text-align:center;
      cursor:pointer; user-select:none;
      transition:background .1s ease, border-color .1s ease, box-shadow .1s ease;
    }
    .radio small{ display:block; margin-top:4px; color:#3b4ea3; }
    .radio:hover{ border-color:#99abff; }
    .radio[aria-checked="true"]{
      background:var(--card-sel);
      border-color:var(--border-strong);
      box-shadow:0 0 0 3px rgba(13,61,168,.15) inset;
    }
    .radio[aria-checked="true"]::after{
      content:"✔";
      position:absolute; top:8px; right:10px;
      background:var(--blue); color:#fff;
      border:2px solid var(--blue-2);
      width:24px; height:24px; border-radius:6px;
      display:grid; place-items:center; font-size:12px;
      box-shadow:2px 2px 0 var(--blue-2);
    }

    .estimate{ font-size:12px; }
    .line{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid #d6defa; }
    .total{ font-size:16px; padding-top:10px; }
    .muted{ font-size:11px; opacity:.8; margin-top:6px; }

    /* Sticky total bar */
    .sticky{
      position: sticky;
      bottom: 0;
      background:#fff;
      border-top:4px solid var(--ink);
      box-shadow:0 -6px 0 var(--ink);
      padding:10px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      z-index:15;
    }
    .sticky .sum{ font-size:14px; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none;
      align-items:center; justify-content:center; padding:16px; z-index:20;
    }
    .modal{
      max-width:560px; width:100%; background:#fff; border:4px solid var(--ink);
      box-shadow:8px 8px 0 var(--ink); border-radius:12px; padding:16px;
    }
    .modal h3{ margin:0 0 8px; font-size:14px; color:#1d4ed8; }
    .modal .row{ margin-top:6px; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

    :focus-visible{ outline:3px dashed var(--focus); outline-offset:3px; }
  </style>
</head>
<body>
  <!-- =========================
       HEADER
  ========================== -->
  <div class="wrap">
    <div class="title">🧼 STFクリーン · おそうじ見積り</div>

    <div class="tbar">
      <button class="btn success" id="contactBtn">この内容で連絡する</button>
    </div>

    <!-- =========================
         MAIN MENU
    ========================== -->
    <section class="panel" aria-labelledby="menuTitle">
      <h2 id="menuTitle" class="section-title">🧾 クリーニングメニュー</h2>

      <div class="grid">
        <!-- ❄️ Aircon (flat ¥5,000 per unit) -->
        <div class="card">
          <div class="section-title">❄️ エアコン掃除</div>
          <div class="field row">
            <span class="label">台数：</span>
            <input type="number" id="acCount" min="0" step="1" value="0" />
            <span class="label" style="opacity:.85;">¥5,000／台</span>
          </div>
        </div>

        <!-- 🧹 Rooms (single choice with 「選択なし」) -->
        <div class="card">
          <div class="section-title">🧹 部屋掃除（間取り）</div>
          <div id="rooms" class="radio-group" role="radiogroup" aria-label="部屋タイプ">
            <div class="radio" role="radio" tabindex="0" data-key="none" aria-checked="true">選択なし<small>—</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="1R/1K" aria-checked="false">1R/1K<small>¥18,000</small></div>
            <!-- 1DK を廃止 → 1LDK に統合 -->
            <div class="radio" role="radio" tabindex="0" data-key="1LDK" aria-checked="false">1LDK<small>¥25,000</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="2LDK" aria-checked="false">2LDK<small>¥30,000</small></div>
            <div class="radio" role="radio" tabindex="0" data-key="3LDK" aria-checked="false">3LDK<small>¥40,000</small></div>
          </div>
          <p class="label" style="opacity:.8;margin-top:8px;">※ 基本清掃の目安。汚れ具合や残置物により変動する場合があります。</p>
        </div>

        <!-- ✨ Options (Wax = free flag / Disposal = ¥2,000〜) -->
        <div class="card">
          <div class="section-title">✨ 追加オプション</div>
          <!-- Wax: just a flag (no price change) -->
          <label class="field row" style="cursor:pointer;">
            <input type="checkbox" id="waxWanted" />
            <span class="label">ワックス希望（追加料金なし）</span>
          </label>

          <!-- Disposal: fixed estimate ¥2,000, with note it may increase -->
          <label class="field row" style="cursor:pointer;">
            <input type="checkbox" id="disposalOpt" />
            <span class="label">残置物処分（¥2,000〜）</span>
          </label>
          <p class="label" style="opacity:.8;">※ 実際の量により増額の可能性があります。現地確認後に正式見積り。</p>
        </div>

        <!-- 📝 Free notes from customer -->
        <div class="card">
          <div class="section-title">📝 ご要望</div>
          <input class="field wide" id="note" placeholder="例：水回り重点・ペットあり・日程の希望 など" />
          <p class="label" style="opacity:.8;">※ ここに書いた内容は見積り本文にも含まれます。</p>
        </div>
      </div>
    </section>

    <!-- =========================
         ESTIMATE OUTPUT
    ========================== -->
    <section class="panel" aria-labelledby="estTitle">
      <h2 id="estTitle" class="section-title">📋 見積り</h2>
      <div id="estimate" class="estimate"></div>
      <div class="muted">
        ※ すべて <strong>税込・駐車場費込み</strong> の目安金額です。状況により金額が変動する場合があります。<br/>
        ※ <strong>最低料金 ¥1,500</strong> を下回る場合は、差額を加算いたします。
      </div>
    </section>
  </div>

  <!-- =========================
       STICKY TOTAL BAR
  ========================== -->
  <div class="sticky" id="sticky">
    <div class="sum">合計（<strong>税込・駐車場費込み</strong>）：<strong id="stickyTotal">¥0</strong></div>
    <button class="btn success sm" id="stickyContact">この内容で連絡する</button>
  </div>

  <!-- =========================
       CONTACT MODAL
  ========================== -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3>📩 この内容で連絡する</h3>

      <div class="row">
        <input id="custName" type="text" class="wide" placeholder="お名前（任意）" />
      </div>
      <div class="row">
        <input id="custEmail" type="text" class="wide" placeholder="ご連絡先メール（任意）" />
      </div>
      <!-- Keep short message but block links (200 chars max) -->
      <div class="row">
        <input id="custMsg" type="text" class="wide" placeholder="メッセージ（任意・URL不可／200文字まで）" maxlength="200" />
      </div>

      <!-- 🕵️ Honeypot (spam trap) — DO NOT DELETE -->
      <input type="text" name="company" id="honeypot" style="display:none" tabindex="-1" autocomplete="off" />

      <p class="label" style="opacity:.8;">※ 送信先メールはページに表示されません（フォーム経由で通知）。</p>
      <div id="sendStatus" class="label" style="opacity:.9;"></div>

      <div class="actions">
        <button class="btn" id="cancelSend">キャンセル</button>
        <button class="btn success" id="sendBtn">送信する</button>
      </div>
    </div>
  </div>

  <script>
    /* ===============================================================
       SETTINGS (prices & endpoint)
       Edit numbers here only; UI and math will update automatically.
    =============================================================== */
    const WEBHOOK_URL = "https://formspree.io/f/xandlaqr";

    // ▶ Room prices (税込)
    const ROOM_PRICES = {
      "1R/1K": 18000,
      "1LDK": 25000,
      "2LDK": 30000,
      "3LDK": 40000
    };

    // ▶ Aircon: flat per unit (税込)
    const AC_PER_UNIT = 5000;

    // ▶ Options
    const DISPOSAL_FEE = 2000; // 残置物処分（見積り上の目安）※増額の可能性あり
    // Wax has no price; it's a flag only.

    // ▶ Overall minimum charge (税込)
    const OVERALL_MIN_TOTAL = 1500;

    // 🚫 Block obvious links in free-text messages
    const LINK_RE = /(https?:\/\/|www\.|\.com\b|\.net\b|\.jp\b|\.ru\b|\.cn\b|\.info\b|\.io\b)/i;

    /* ===============================================================
       DOM HOOKS
    =============================================================== */
    const acCountEl = document.getElementById('acCount');
    const waxWantedEl = document.getElementById('waxWanted');
    const disposalEl = document.getElementById('disposalOpt');
    const noteEl = document.getElementById('note');
    const estimateEl = document.getElementById('estimate');

    const roomsEl = document.getElementById('rooms');

    const contactBtn = document.getElementById('contactBtn');
    const sticky = document.getElementById('sticky');
    const stickyTotal = document.getElementById('stickyTotal');
    const stickyContact = document.getElementById('stickyContact');

    const modal = document.getElementById('modal');
    const cancelSend = document.getElementById('cancelSend');
    const sendBtn = document.getElementById('sendBtn');
    const sendStatus = document.getElementById('sendStatus');
    const custName = document.getElementById('custName');
    const custEmail = document.getElementById('custEmail');
    const custMsg = document.getElementById('custMsg');

    /* ===============================================================
       STATE (single-choice room)
    =============================================================== */
    let selectedRoom = null;

    // Room selection cards (tap to select / tap again to unselect; 「選択なし」 clears)
    roomsEl.querySelectorAll('.radio').forEach(r => {
      r.addEventListener('click', () => chooseRoom(r.dataset.key));
      r.addEventListener('keydown', (e) => { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); chooseRoom(r.dataset.key); } });
    });
    function chooseRoom(key){
      if(key === 'none'){ selectedRoom = null; }
      else if(selectedRoom === key){ selectedRoom = null; }
      else { selectedRoom = key; }

      roomsEl.querySelectorAll('.radio').forEach(x => {
        const isChecked = (selectedRoom === null && x.dataset.key === 'none') || (x.dataset.key === selectedRoom);
        x.setAttribute('aria-checked', isChecked ? 'true' : 'false');
      });
      render();
    }

    /* ===============================================================
       COMPUTE (build line items & totals)
    =============================================================== */
    function compute(){
      const acCount = Math.max(0, parseInt(acCountEl.value || "0", 10));
      const waxFlag = !!waxWantedEl.checked;
      const disposalFlag = !!disposalEl.checked;
      const note = (noteEl.value || "").trim();

      // Aircon total
      const ac = acCount * AC_PER_UNIT;

      // Room total (0 if none)
      const room = selectedRoom ? (ROOM_PRICES[selectedRoom] || 0) : 0;

      // Disposal total (fixed 2,000 if checked)
      const disposal = disposalFlag ? DISPOSAL_FEE : 0;

      // Items to display
      const items = [];
      if(acCount>0) items.push({label:`❄️ エアコン掃除（${acCount}台）`, price: ac});
      if(selectedRoom) items.push({label:`🧹 部屋掃除（${selectedRoom}）`, price: room});
      if(waxFlag) items.push({label:`✨ ワックス希望（追加料金なし）`, price: 0});
      if(disposalFlag) items.push({label:`🧺 残置物処分（目安）`, price: disposal});

      // Subtotal
      const subtotal = items.reduce((s, x)=>s+x.price, 0);

      // Minimum charge adjustment (rare, but kept for safety)
      const needsMin = items.length > 0 && subtotal > 0 && subtotal < OVERALL_MIN_TOTAL;
      const minAdj = needsMin ? (OVERALL_MIN_TOTAL - subtotal) : 0;

      // Final total (税込・駐車場費込み)
      const total = subtotal + minAdj;

      return { items, subtotal, minAdj, total, note };
    }

    /* ===============================================================
       RENDER (draw estimate + sticky bar)
    =============================================================== */
    function render(){
      const { items, subtotal, minAdj, total } = compute();
      estimateEl.innerHTML = '';

      if(items.length === 0){
        estimateEl.innerHTML = '<p class="label" style="opacity:.8;">メニューから項目を入力／選択してください。</p>';
      } else {
        items.forEach(it => {
          const row = document.createElement('div');
          row.className = 'line';
          row.innerHTML = `<div>${it.label}</div><div>${it.price > 0 ? '¥'+it.price.toLocaleString() : '—'}</div>`;
          estimateEl.appendChild(row);
        });

        const subRow = document.createElement('div');
        subRow.className = 'line';
        subRow.innerHTML = `<div>小計</div><div>¥${subtotal.toLocaleString()}</div>`;
        estimateEl.appendChild(subRow);

        if(minAdj > 0){
          const minRow = document.createElement('div');
          minRow.className = 'line';
          minRow.innerHTML = `<div>🔖 最低料金調整（最低 ¥${OVERALL_MIN_TOTAL.toLocaleString()}）</div><div>+¥${minAdj.toLocaleString()}</div>`;
          estimateEl.appendChild(minRow);
        }

        const totalRow = document.createElement('div');
        totalRow.className = 'line total';
        totalRow.innerHTML = `<strong>合計（<span style="font-weight:700">税込・駐車場費込み</span>）</strong><strong>¥${total.toLocaleString()}</strong>`;
        estimateEl.appendChild(totalRow);
      }

      const computed = compute();
      stickyTotal.textContent = `¥${computed.total.toLocaleString()}`;
      sticky.style.display = computed.items.length ? 'flex' : 'none';
    }

    /* ===============================================================
       MODAL OPEN/CLOSE
    =============================================================== */
    function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); sendStatus.textContent=''; }

    modal.addEventListener('click', (e) => { if(e.target === modal){ closeModal(); } });
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false'){ closeModal(); }
    });

    contactBtn.addEventListener('click', () => {
      if(compute().items.length === 0){
        alert('まずはメニューを入力／選択してください。');
        return;
      }
      openModal();
    });
    stickyContact.addEventListener('click', () => {
      if(compute().items.length === 0){ return; }
      openModal();
    });
    cancelSend.addEventListener('click', closeModal);

    /* ===============================================================
       EMAIL TEXT (with phishing/scam warnings)
    =============================================================== */
    function buildText(){
      const { items, subtotal, minAdj, total, note } = compute();
      const lines = [];
      lines.push('【STFクリーン おそうじ見積り】');
      items.forEach(it => lines.push(`・${it.label}：${it.price>0 ? '¥'+it.price.toLocaleString() : '—'}`));
      lines.push(`小計：¥${subtotal.toLocaleString()}`);
      if(minAdj > 0){
        lines.push(`最低料金調整（最低 ¥${OVERALL_MIN_TOTAL.toLocaleString()}）：+¥${minAdj.toLocaleString()}`);
      }
      lines.push(`———`);
      lines.push(`合計（税込・駐車場費込み）：¥${total.toLocaleString()}`);
      if(note){ lines.push(`ご要望：${note}`); }
      lines.push(`作成：${new Date().toLocaleString('ja-JP')}`);

      // ⚠️ Phishing/scam checklist for your husband
      lines.push('');
      lines.push('——— 注意喚起（フィッシング・詐欺対策）———');
      lines.push('・不審なリンクや添付ファイルは開かないでください。');
      lines.push('・差出人のメールアドレスとドメインを必ず確認してください。');
      lines.push('・支払いを促すリンク／QRコード／ギフトカード要求は無視してください。');
      lines.push('・個人情報（口座・住所・身分証）の提供依頼は電話で再確認してください。');
      lines.push('・少しでも怪しい場合は返信せず、公式経路から再確認してください。');

      return lines.join('\n');
    }

    /* ===============================================================
       SEND (Formspree) — honeypot + link blocking in message
    =============================================================== */
    sendBtn.addEventListener('click', async () => {
      // Honeypot
      const trap = document.getElementById('honeypot');
      if (trap && trap.value) { console.log("Spam detected via honeypot. Ignored."); return; }

      // Validate message: no links, <= 200 chars
      const msg = (custMsg.value || '').trim();
      if (msg.length > 200) {
        sendStatus.textContent = '❌ メッセージは200文字以内で入力してください。';
        return;
      }
      if (LINK_RE.test(msg)) {
        sendStatus.textContent = '❌ URL/リンクは入力できません。必要な場合はメールでご共有ください。';
        return;
      }

      const payload = {
        estimate_text: buildText(),
        selections: compute(),
        customer: {
          name: (custName.value || '').trim(),
          email: (custEmail.value || '').trim(),
          message: msg
        },
        _subject: "STFクリーン 新規見積り（サイトから）",
        _replyto: (custEmail.value || '').trim()
      };

      sendStatus.textContent = '送信中…';

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          sendStatus.textContent = '✅ 送信しました。担当者からご連絡いたします。';
          setTimeout(() => { closeModal(); }, 1500);
        } else {
          sendStatus.textContent = '❌ 送信に失敗しました（' + res.status + '）。';
        }
      } catch (err) {
        sendStatus.textContent = '❌ 送信に失敗しました。ネットワークをご確認ください。';
      }
    });

    /* ===============================================================
       LIVE UPDATES
    =============================================================== */
    [acCountEl, waxWantedEl, disposalEl, noteEl].forEach(el => {
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    });
    render();
  </script>
</body>
</html>
